<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="css/main.css" />
  <script src="js/d3.v3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.min.js"></script>
  <title>Subscribers Growth Over Time</title>
</head>
<body>
  <div id="container">
    <div id="map-container"></div>
  </div>
  <script>
  var width = 960, height = 550;

  var projection = d3.geo.albersUsa()
    .translate([width / 2, height / 2])
    .scale(750);

  var path = d3.geo.path()
      .projection(projection);

  var svg = d3.select("#map-container").append("svg")
      .attr("width", width)
      .attr("height", height);

  var g = svg.append("g");

  g.append("rect")
    .attr("width",width)
    .attr("height",height)
    .attr("fill","white")
    .attr("opacity",0)
    .on("mouseover",function(){
      hoverData = null;
      if ( tooltip ) tooltip.style("display","none");
    })

  var map = g.append("g")
      .attr("id","map");

  var tooltip,
      hoverData;

  d3.json("json/us.json", function(error, us) {
    map.selectAll("path")
        .data(topojson.feature(us, us.objects.states).features)
        .enter()
        .append("path")
        .attr("vector-effect","non-scaling-stroke")
        .attr("class","land")
        .attr("d", path);

     map.append("path")
         .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
         .attr("class", "state-boundary")
         .attr("vector-effect","non-scaling-stroke")
         .attr("d", path);

    tooltip = d3.select("#map-container").append("div")
      .attr("id","tooltip");

    d3.csv("data/us-cities.csv",function(data){
        //draw city points
        map.selectAll("circle")
            .data(data)
            .enter().append("circle")
                .attr("cx", function(d){ return projection([d.lon, d.lat])[0]; })
                .attr("cy", function(d){ return projection([d.lon, d.lat])[1]; })
                .attr("r", function(d){ return Math.sqrt(parseInt(d.population)*0.00005); })
                .attr("vector-effect","non-scaling-stroke")
                .attr("class", "loss")
                .on("mousemove", function(d){
                  hoverData = d;
                  setTooltipContent(d);
                  tooltip
                    .style( {
                      "display" : "block",
                      "top" : (d3.event.pageY - 80) + "px",
                      "left" : (d3.event.pageX + 10) + "px"
                    })
                })
                .on("mouseout", function(){
                  hoverData = null;
                  tooltip.style("display","none");
                });

      createLegend();

    })

  });

  function circleSize(d){
    return Math.sqrt( .01 * Math.abs(d) );
  };

  function createLegend(){
    var legend = g.append("g").attr("id","legend").attr("transform","translate(560,10)");

    legend.append("circle").attr("class","loss").attr("r",5).attr("cx",5).attr("cy",30)
    legend.append("text").text("no. subscribers").attr("x",15).attr("y",33);

    var sizes = [ 100000, 500000, 1000000 ];
    for ( var i in sizes ){
      legend.append("circle")
        .attr( "r", circleSize( sizes[i] ) )
        .attr( "cx", 80 + circleSize( sizes[sizes.length-1] ) )
        .attr( "cy", 2 * circleSize( sizes[sizes.length-1] ) - circleSize( sizes[i] ) )
        .attr("vector-effect","non-scaling-stroke");
      legend.append("text")
        .text( (sizes[i] / 1000) + "K" + (i == sizes.length-1 ? " members" : "") )
        .attr( "text-anchor", "middle" )
        .attr( "x", 80 + circleSize( sizes[sizes.length-1] ) )
        .attr( "y", 2 * ( circleSize( sizes[sizes.length-1] ) - circleSize( sizes[i] ) ) + 5 )
        .attr( "dy", 13)
    }
  }

  function setTooltipContent(d){
    var html = "<center><strong>" + d.place + "</strong><br/>" +
              "<span>" + d.population + "</span></center>";
    tooltip.html( html );
  }

  </script>
</body>
</html>
